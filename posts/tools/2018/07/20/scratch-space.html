<!DOCTYPE HTML>

<html>
    <head>
        <title>
            Scratch space using tmpfs and friends
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" type="image/png" href="../../../../../static/images/pencil.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
            
        </script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js">
            
        </script>
        <style>
            
@import url(https://fonts.googleapis.com/css?family=Roboto+Condensed:400,400i,700|Roboto+Mono:400,400i,700&subset=cyrillic);
body
{
  font-family      : "Roboto Condensed", sans-serif;
  font-size        : 18px;
  background-color : #f6f6f6;
  background-image : url("/static/images/satinweave.png");
}

a:hover
{
  color : black !important;
}

a:link
{
  color : black !important;
}

a:visited
{
  color : black !important;
}

a:active
{
  color : black !important;
}

.footer
{
  margin         : 0px auto 0px auto;
  max-width      : 86%;
  padding-top    : 70px;
  padding-bottom : 50px;
  color          : #777777;
  font-size      : 94%;
}

.left
{
  text-align : left;
}

.right
{
  text-align : right;
}

.center
{
  text-align : center;
}

h1
{
  text-align     : center;
  font-size      : 200%;
  padding-top    : 30px;
  padding-bottom : 30px;
}

h2
{
  font-size      : 160%;
  padding-top    : 30px;
  padding-bottom : 25px;
}

h3
{
  font-size      : 140%;
  padding-top    : 25px;
  padding-bottom : 20px;
}

a
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:hover
{
  color           : #5493ff;
  text-decoration : none;
  border-bottom   : solid 1px #999999;
}

a:visited
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:active
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

.href-to-original
{
  text-align  : right;
  font-size   : 90%;
  padding-top : 10px;
}

#authors-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#about-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#tags-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#categories-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-1
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-2
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-3
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-4
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-5
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#go-home
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#hakyll-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#mit-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

.fpconf-link
{
  font-size : 120%;
}

.fby-link
{
  font-size : 120%;
}

.friends-separator
{
  padding-left : 30px;
}

.navigation
{
  max-width      : 86%;
  margin         : 0px auto 0px auto;
  padding-top    : 40px;
  padding-bottom : 40px;
  font-size      : 120%;
}

.links
{
  margin-top     : 17px;
  font-size      : 90%;
  padding-bottom : 10px;
}

.logo-area
{
  text-align : center;
}

.social-links
{
  text-align : right;
  margin-top : 10px;
  font-size  : 140%;
}

.social-links-separator
{
  padding-right : 20px;
}

.links-separator
{
  padding-right : 20px;
}

.reddit-color
{
  color : #ff4500;
}

.twitter-color
{
  color : #1da1f2;
}

.gitter-color
{
  color : #e10454;
}

.github-color
{
  color : #000000;
}

.rss-color
{
  color : #ff924a;
}

.name-of-category
{
  font-size        : 85%;
  border           : solid 1px #ffbcb1;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fec1b7;
  padding-top      : 3px;
  padding-bottom   : 3px;
  padding-left     : 5px;
  padding-right    : 5px;
  margin-right     : 22px;
}

.post-info
{
  color          : #777777;
  font-size      : 90%;
  font-family    : "Roboto Mono", monospace;
  text-align     : left;
  padding-top    : 10px;
  padding-bottom : 60px;
}

.post-list
{
  padding         : 0px 0px 0px 0px;
  margin          : 0px 0px 0px 0px;
  list-style-type : none;
  font-size       : 110%;
}


.post-list li
{
  margin-top     : 10px;
  padding-bottom : 10px;
}


.post-list a
{
  text-decoration : none;
}


.post-list a:hover
{
  text-decoration : none;
}

.post-comments
{
  padding-left  : 15px;
  padding-right : 5px;
  font-size     : 90%;
  color         : #777777;
}

.comments-link
{
  font-size : 90%;
  color     : #777777;
}

.post-date
{
  text-align : right;
  color      : #888888;
}

.archive-button
{
  padding-top : 26px;
}

.undecorated
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

img[src*='#center']
{
  margin    : 0px auto 0px auto;
  display   : block;
  max-width : 100%;
}

.social-buttons-separator
{
  padding-top : 40px;
}

.heart-color
{
  color : #ff3a1d;
}

.tags-cloud
{
  text-align     : center;
  padding-top    : 30px;
  padding-bottom : 30px;
  margin         : 0px auto 0px auto;
  max-width      : 60%;
}

.tag-default
{
  background-color : #fec1b7;
  border           : solid 1px #ffbcb1;
  color            : inherit;
}


.sourceCode code
{
  font-family : "Roboto Mono", monospace;
}

pre.sourceCode
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border           : solid 1px #fbe7d8;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fdf6e3;
  color            : #073642;
  padding-top      : 10px;
  padding-bottom   : 10px;
  padding-left     : 15px;
  padding-right    : 15px;
  margin-top       : 20px;
  margin-bottom    : 20px;
}


#content p > code
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border-radius    : 3px 3px 3px 3px;
  border           : solid 1px #fbe7d8;
  background-color : #fdf6e3;
  color            : #000000;
  padding-top      : 1px;
  padding-bottom   : 1px;
  padding-left     : 4px;
  padding-right    : 4px;
}


pre.sourceCode span.kw
{
  color       : #007020;
  font-weight : 600;
}


pre.sourceCode span.dt
{
  color : #902000;
}


pre.sourceCode span.dv
{
  color : #40a070;
}


pre.sourceCode span.bn
{
  color : #40a070;
}


pre.sourceCode span.fl
{
  color : #40a070;
}


pre.sourceCode span.ch
{
  color : #4070a0;
}


pre.sourceCode span.co
{
  color : #60a0b0;
}


pre.sourceCode span.ot
{
  color : #007020;
}


pre.sourceCode span.al
{
  color       : #fa0202;
  font-weight : 600;
}


pre.sourceCode span.fu
{
  color : #06287e;
}


pre.sourceCode span.er
{
  color       : #fa0202;
  font-weight : 600;
}

a.sourceLine
{
  border-bottom : none;
}


/* Generated with Clay, http://fvisser.nl/clay */
        </style>
        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://budevg.github.io/feed.xml">
    </head>
    <body>
        <div class="container-fluid">
            <div class="navigation">
                <div class="row">
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="links">
                            <a href="../../../../../tags.html" id="tags-link">
                                Tags
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../categories.html" id="categories-link">
                                Categories
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../about.html" id="about-link">
                                About
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <div class="logo-area">
                            <a href="../../../../../" title="Home" id="go-home">
                                <h2>
                                    Meta-x86
                                </h2>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="social-links">
                            <a href="https://twitter.com/budevg" id="sl-2" title="Follow me on twitter">
                                <i class="fa fa-twitter twitter-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="https://github.com/budevg" id="sl-4" title="My Github repositories">
                                <i class="fa fa-github github-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="../../../../../feed.xml" id="sl-5" title="Blog RSS">
                                <i class="fa fa-rss rss-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="content">
                <h1>
    Scratch space using tmpfs and friends
</h1>
<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/Evgeny%20Budilovsky.html">Evgeny Budilovsky</a>"<br />
date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 2018 Jul 20<br />
category = "<a href="../../../../../categories/tools.html">tools</a>"<br />
tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/tmpfs.html">tmpfs</a>&quot;, &quot;<a href="../../../../../tags/overlayfs.html">overlayfs</a>&quot;]

        </div>
    </div>
    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        

    </div>
</div>
<div>
    <p>When programming I tend to generate many files that I don’t want to save persistently on my storage media. Pdf documents I download, github repositories I clone to check something in source code and many other types of files should be stored somewhere but I would be glad to get rid of them when I power off my laptop.</p>
<p>For this purpose I use the following script which creates tmpfs memory backed file system which is mounted at <code>~/scratch</code>. I use this directory to store all temporary files and I know they will disappear after I reboot.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">#!/bin/sh</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">sudo</span> mount -t tmpfs -o size=8G none ~/scratch/</a></code></pre></div>
<p>Another use case is when I want to temporarily install some packages to try new stuff. For example if I want to compile some <code>haskell</code> application using <code>stack</code>. Stack is going to pull and compile many new packages and it will store them at <code>~/.stack</code>. If I don’t want to persistently store all these packages on my storage media, I can do the following trick. Create <code>~/scratch/stack-shadow</code> directory. Use overlayfs to create new file system that mirrors the old directory and stores all modified or newly created files in new directory. Using <code>mount -o bind</code> to bind the overlayfs directory to the <code>~/.stack</code> location</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">mkdir</span> -p ~/scratch/stack-shadow/upperdir \</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">         ~/scratch/stack-shadow/workdir  \</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">         ~/scratch/stack-shadow/export</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="fu">sudo</span> mount -t overlay overlay \</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">           -olowerdir=~/.stack \</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">           -oupperdir=~/scratch/stack-shadow/upperdir \</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">           -oworkdir=~/scratch/stack-shadow/workdir  \</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">           ~/scratch/stack-shadow/export</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="fu">sudo</span> mount -o bind ~/scratch/stack-shadow/export ~/.stack</a></code></pre></div>
<p>We can build a bash script to automate these commands.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">#!/bin/bash</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">function</span><span class="fu"> usage</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">    <span class="bu">echo</span> <span class="st">&quot;usage: </span><span class="va">$0</span><span class="st"> &lt;command&gt; &lt;src&gt; &lt;dst&gt;&quot;</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">    <span class="bu">echo</span> <span class="st">&quot;commands:&quot;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="bu">echo</span> -e <span class="st">&quot;\tnew - bind dst to location at src&quot;</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    <span class="bu">echo</span> -e <span class="st">&quot;\tshadow  - overlay src to dst, bind dst to src&quot;</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="bu">echo</span> -e <span class="st">&quot;\tdup - overlay src to dst&quot;</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    <span class="bu">echo</span> -e <span class="st">&quot;\tclear - umount src and dst&quot;</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="bu">exit</span> 1</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">}</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="kw">function</span><span class="fu"> new</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">    <span class="bu">local</span> <span class="va">src=$1</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15">    <span class="bu">local</span> <span class="va">dst=$2</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">    <span class="fu">mkdir</span> -p <span class="va">$dst</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">    <span class="fu">sudo</span> mount -o bind <span class="va">$dst</span> <span class="va">$src</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="kw">}</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="kw">function</span><span class="fu"> shadow</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">    <span class="bu">local</span> <span class="va">src=$1</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">    <span class="bu">local</span> <span class="va">dst=$2</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">    <span class="ex">dup</span> <span class="va">$src</span> <span class="va">$dst</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">    <span class="fu">sudo</span> mount -o bind <span class="va">$dst</span>/export <span class="va">$src</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="kw">}</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="kw">function</span><span class="fu"> dup</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28">    <span class="bu">local</span> <span class="va">src=$1</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">    <span class="bu">local</span> <span class="va">dst=$2</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30">    <span class="fu">mkdir</span> -p <span class="va">$dst</span>/upperdir <span class="va">$dst</span>/workdir <span class="va">$dst</span>/export</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">    <span class="fu">sudo</span> mount -t overlay overlay -olowerdir=<span class="va">$src</span> -oupperdir=<span class="va">$dst</span>/upperdir -oworkdir=<span class="va">$dst</span>/workdir <span class="va">$dst</span>/export</a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="kw">}</span></a>
<a class="sourceLine" id="cb3-33" data-line-number="33"></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="kw">function</span><span class="fu"> clear</span> <span class="kw">{</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35">    <span class="bu">local</span> <span class="va">src=$1</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36">    <span class="bu">local</span> <span class="va">dst=$2</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37">    <span class="bu">test</span> -d <span class="va">$src</span> <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> umount <span class="va">$src</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38">    <span class="bu">test</span> -d <span class="va">$dst</span>/export <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> umount <span class="va">$dst</span>/export</a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="kw">}</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"><span class="kw">if</span><span class="bu"> [</span> <span class="va">$#</span> <span class="ot">-lt</span> 3<span class="bu"> ]</span>; <span class="kw">then</span> <span class="ex">usage</span><span class="kw">;</span> <span class="kw">fi</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"></a>
<a class="sourceLine" id="cb3-43" data-line-number="43"><span class="kw">set</span> <span class="ex">-x</span></a>
<a class="sourceLine" id="cb3-44" data-line-number="44"></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="kw">case</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span><span class="kw"> in</span></a>
<a class="sourceLine" id="cb3-46" data-line-number="46">    new<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-47" data-line-number="47">        <span class="ex">new</span> <span class="va">$2</span> <span class="va">$3</span></a>
<a class="sourceLine" id="cb3-48" data-line-number="48">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-49" data-line-number="49">    shadow<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-50" data-line-number="50">        <span class="ex">shadow</span> <span class="va">$2</span> <span class="va">$3</span></a>
<a class="sourceLine" id="cb3-51" data-line-number="51">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52">    dup<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-53" data-line-number="53">        <span class="ex">dup</span> <span class="va">$2</span> <span class="va">$3</span></a>
<a class="sourceLine" id="cb3-54" data-line-number="54">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-55" data-line-number="55">    clear<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56">        <span class="fu">clear</span> <span class="va">$2</span> <span class="va">$3</span></a>
<a class="sourceLine" id="cb3-57" data-line-number="57">        <span class="kw">;;</span></a>
<a class="sourceLine" id="cb3-58" data-line-number="58">    *<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-59" data-line-number="59">        <span class="ex">usage</span></a>
<a class="sourceLine" id="cb3-60" data-line-number="60"><span class="kw">esac</span></a></code></pre></div>
</div>

            </div>
        </div>
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 left">
                        
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 center">
                        
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 right">
                        
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
