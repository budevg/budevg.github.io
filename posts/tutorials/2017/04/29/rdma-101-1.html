<!DOCTYPE HTML>

<html>
    <head>
        <title>
            RDMA 101 - Buiding virtual setup
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" type="image/png" href="../../../../../static/images/pencil.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
            
        </script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js">
            
        </script>
        <style>
            
@import url(https://fonts.googleapis.com/css?family=Roboto+Condensed:400,400i,700|Roboto+Mono:400,400i,700&subset=cyrillic);
body
{
  font-family      : "Roboto Condensed", sans-serif;
  font-size        : 18px;
  background-color : #f6f6f6;
  background-image : url("/static/images/satinweave.png");
}

a:hover
{
  color : black !important;
}

a:link
{
  color : black !important;
}

a:visited
{
  color : black !important;
}

a:active
{
  color : black !important;
}

.footer
{
  margin         : 0px auto 0px auto;
  max-width      : 86%;
  padding-top    : 70px;
  padding-bottom : 50px;
  color          : #777777;
  font-size      : 94%;
}

.left
{
  text-align : left;
}

.right
{
  text-align : right;
}

.center
{
  text-align : center;
}

h1
{
  text-align     : center;
  font-size      : 200%;
  padding-top    : 30px;
  padding-bottom : 30px;
}

h2
{
  font-size      : 160%;
  padding-top    : 30px;
  padding-bottom : 25px;
}

h3
{
  font-size      : 140%;
  padding-top    : 25px;
  padding-bottom : 20px;
}

a
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:hover
{
  color           : #5493ff;
  text-decoration : none;
  border-bottom   : solid 1px #999999;
}

a:visited
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:active
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

.href-to-original
{
  text-align  : right;
  font-size   : 90%;
  padding-top : 10px;
}

#authors-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#about-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#tags-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#categories-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-1
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-2
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-3
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-4
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-5
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#go-home
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#hakyll-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#mit-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

.fpconf-link
{
  font-size : 120%;
}

.fby-link
{
  font-size : 120%;
}

.friends-separator
{
  padding-left : 30px;
}

.navigation
{
  max-width      : 86%;
  margin         : 0px auto 0px auto;
  padding-top    : 40px;
  padding-bottom : 40px;
  font-size      : 120%;
}

.links
{
  margin-top     : 17px;
  font-size      : 90%;
  padding-bottom : 10px;
}

.logo-area
{
  text-align : center;
}

.social-links
{
  text-align : right;
  margin-top : 10px;
  font-size  : 140%;
}

.social-links-separator
{
  padding-right : 20px;
}

.links-separator
{
  padding-right : 20px;
}

.reddit-color
{
  color : #ff4500;
}

.twitter-color
{
  color : #1da1f2;
}

.gitter-color
{
  color : #e10454;
}

.github-color
{
  color : #000000;
}

.rss-color
{
  color : #ff924a;
}

.name-of-category
{
  font-size        : 85%;
  border           : solid 1px #ffbcb1;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fec1b7;
  padding-top      : 3px;
  padding-bottom   : 3px;
  padding-left     : 5px;
  padding-right    : 5px;
  margin-right     : 22px;
}

.post-info
{
  color          : #777777;
  font-size      : 90%;
  font-family    : "Roboto Mono", monospace;
  text-align     : left;
  padding-top    : 10px;
  padding-bottom : 60px;
}

.post-list
{
  padding         : 0px 0px 0px 0px;
  margin          : 0px 0px 0px 0px;
  list-style-type : none;
  font-size       : 110%;
}


.post-list li
{
  margin-top     : 10px;
  padding-bottom : 10px;
}


.post-list a
{
  text-decoration : none;
}


.post-list a:hover
{
  text-decoration : none;
}

.post-comments
{
  padding-left  : 15px;
  padding-right : 5px;
  font-size     : 90%;
  color         : #777777;
}

.comments-link
{
  font-size : 90%;
  color     : #777777;
}

.post-date
{
  text-align : right;
  color      : #888888;
}

.archive-button
{
  padding-top : 26px;
}

.undecorated
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

img[src*='#center']
{
  margin    : 0px auto 0px auto;
  display   : block;
  max-width : 100%;
}

.social-buttons-separator
{
  padding-top : 40px;
}

.heart-color
{
  color : #ff3a1d;
}

.tags-cloud
{
  text-align     : center;
  padding-top    : 30px;
  padding-bottom : 30px;
  margin         : 0px auto 0px auto;
  max-width      : 60%;
}

.tag-default
{
  background-color : #fec1b7;
  border           : solid 1px #ffbcb1;
  color            : inherit;
}


.sourceCode code
{
  font-family : "Roboto Mono", monospace;
}

pre.sourceCode
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border           : solid 1px #fbe7d8;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fdf6e3;
  color            : #073642;
  padding-top      : 10px;
  padding-bottom   : 10px;
  padding-left     : 15px;
  padding-right    : 15px;
  margin-top       : 20px;
  margin-bottom    : 20px;
}


#content p > code
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border-radius    : 3px 3px 3px 3px;
  border           : solid 1px #fbe7d8;
  background-color : #fdf6e3;
  color            : #000000;
  padding-top      : 1px;
  padding-bottom   : 1px;
  padding-left     : 4px;
  padding-right    : 4px;
}


pre.sourceCode span.kw
{
  color       : #007020;
  font-weight : 600;
}


pre.sourceCode span.dt
{
  color : #902000;
}


pre.sourceCode span.dv
{
  color : #40a070;
}


pre.sourceCode span.bn
{
  color : #40a070;
}


pre.sourceCode span.fl
{
  color : #40a070;
}


pre.sourceCode span.ch
{
  color : #4070a0;
}


pre.sourceCode span.co
{
  color : #60a0b0;
}


pre.sourceCode span.ot
{
  color : #007020;
}


pre.sourceCode span.al
{
  color       : #fa0202;
  font-weight : 600;
}


pre.sourceCode span.fu
{
  color : #06287e;
}


pre.sourceCode span.er
{
  color       : #fa0202;
  font-weight : 600;
}


/* Generated with Clay, http://fvisser.nl/clay */
        </style>
        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://budevg.github.io/feed.xml">
    </head>
    <body>
        <div class="container-fluid">
            <div class="navigation">
                <div class="row">
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="links">
                            <a href="../../../../../tags.html" id="tags-link">
                                Tags
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../categories.html" id="categories-link">
                                Categories
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../about.html" id="about-link">
                                About
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <div class="logo-area">
                            <a href="../../../../../" title="Home" id="go-home">
                                <h2>
                                    Meta-x86
                                </h2>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="social-links">
                            <a href="https://twitter.com/budevg" id="sl-2" title="Follow me on twitter">
                                <i class="fa fa-twitter twitter-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="https://github.com/budevg" id="sl-4" title="My Github repositories">
                                <i class="fa fa-github github-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="../../../../../feed.xml" id="sl-5" title="Blog RSS">
                                <i class="fa fa-rss rss-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="content">
                <h1>
    RDMA 101 - Buiding virtual setup
</h1>
<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/Evgeny%20Budilovsky.html">Evgeny Budilovsky</a>"<br />
date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 2017 Apr 29<br />
category = "<a href="../../../../../categories/tutorials.html">tutorials</a>"<br />
tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/storage.html">storage</a>&quot;, &quot;<a href="../../../../../tags/rdma.html">rdma</a>&quot;, &quot;<a href="../../../../../tags/qemu.html">qemu</a>&quot;]

        </div>
    </div>
    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        

    </div>
</div>
<div>
    <p>We are going to explore RDMA and it’s applications in a series of tutorials starting with this one.</p>
<p>The first step is to build virtual environment where we can run our applications. Usually RDMA communication requires special RDMA capable NIC on your server. Many vendors, such as <a href="https://www.mellanox.com/">Mellanox</a>, sell this hardware but for our development effort we are going to build a virtual environment based on <a href="http://www.qemu-project.org/">qemu</a> and <a href="https://github.com/zrlio/softiwarp">softiwarp</a> software.</p>
<h1 id="virtual-environment">Virtual environment</h1>
<h2 id="base-image">Base image</h2>
<p>We start with ubuntu 16.04.2 qemu image. It has linux kernel 4.8 installed and a basic development tools</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">sudo</span> apt-get install linux-generic-hwe-16.04 build-essential \
                       automake autoconf libtool</code></pre></div>
<p>Let’s call this image <code>ubuntu-16.04.2-dev</code>. We are going to create another image based on this image with all the rdma stack installed on it called <code>ubuntu-rdma.qcow2</code></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">qemu-img</span> create -f qcow2 -b ubuntu-16.04.2-dev ubuntu-rdma.qcow2
<span class="ex">Formatting</span> <span class="st">'ubuntu-rdma.qcow2'</span> ...</code></pre></div>
<p>Let’s start a guest and install RDMA stack inside of it.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">kvm</span> -m 1G \
-netdev user,hostfwd=tcp::5555-:22,id=net0 \
-device virtio-net-pci,netdev=net0 \
-drive if=virtio,file=ubuntu-rdma.qcow2,cache=unsafe</code></pre></div>
<p>We can ssh to guest through local port 5555 which is redirected to port 22 on guest.</p>
<h2 id="install-rdma-libraries-and-tools">Install RDMA libraries and tools</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">sudo</span> apt-get install libibverbs-dev librdmacm-dev \
                       rdmacm-utils perftest ibverbs-utils</code></pre></div>
<h2 id="install-softiwarp">Install SoftiWARP</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">git</span> clone https://github.com/zrlio/softiwarp.git
<span class="ex">...</span>
$ <span class="bu">pushd</span> softiwarp/kernel
$ <span class="fu">make</span>
$ <span class="fu">sudo</span> mkdir -p /lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/kernel/extra
$ <span class="fu">sudo</span> cp siw.ko /lib/modules/<span class="kw">`</span><span class="fu">uname</span> -r<span class="kw">`</span>/kernel/extra
$ <span class="fu">sudo</span> depmod -a
$ <span class="bu">popd</span>
$ <span class="bu">pushd</span> softiwarp/userlib
$ <span class="ex">./autogen.sh</span> <span class="kw">&amp;&amp;</span> <span class="ex">./configure</span> --prefix= <span class="kw">&amp;&amp;</span> <span class="fu">make</span> <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> make install</code></pre></div>
<h2 id="shutdown">Shutdown</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">sudo</span> shutdown -h now</code></pre></div>
<h2 id="create-two-guests">Create two guests</h2>
<p>Based on the <code>ubuntu-rdma.qcow2</code> image we just created let’s build two images <code>vm1.qcow2</code> and <code>vm2.qcow2</code></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">for</span> <span class="ex">i</span> in <span class="dt">{1..2}</span><span class="kw">;</span> <span class="kw">do</span> <span class="ex">qemu-img</span> create -f qcow2 -b ubuntu-rdma.qcow2 vm<span class="va">${i}</span>.qcow2<span class="kw">;</span> <span class="kw">done</span>
$ <span class="fu">ls</span> vm*
<span class="ex">vm1.qcow2</span>  vm2.qcow2</code></pre></div>
<p>Now we are going to run both guest. Each of them will have two network interfaces. The first interface is configured to allow access from the guest to the internet and to allow access from the host to the guest’s ssh service by connecting to local port 5551 (or 5552 for second vm). The second network interface will be used for rdma access we are going to use qemu’s feature to create network using UDP multicast socket.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">for</span> <span class="ex">i</span> in <span class="dt">{1..2}</span>
<span class="kw">do</span>
  <span class="ex">kvm</span> -name vm<span class="va">${i}</span> -m 1G \
      -netdev user,hostfwd=tcp::555<span class="va">${i}</span>-:22,id=net0 \
      -device virtio-net-pci,netdev=net0 \
      -netdev socket,mcast=230.0.0.1:1234,id=net1 \
      -device virtio-net-pci,mac=52:54:00:12:34:0<span class="va">${i}</span>,netdev=net1 \
      -drive if=virtio,file=vm<span class="va">${i}</span>.qcow2,cache=unsafe <span class="kw">&amp;</span>
<span class="kw">done</span></code></pre></div>
<p>Now login to each of the machines and set hostname and ip for the rdma nic:</p>
<ul>
<li><p>vm1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ssh</span> -p 5551 localhost
<span class="ex">vm1</span> $ sudo bash -c <span class="st">'echo 127.0.0.1 vm1 &gt;&gt; /etc/hosts'</span>
<span class="ex">vm1</span> $ sudo hostnamectl set-hostname vm1
<span class="ex">vm1</span> $ sudo su
<span class="ex">vm1</span> $ cat <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;&gt;</span> <span class="ex">/etc/network/interfaces</span>
auto ens4
iface ens4 inet <span class="op">s</span><span class="ex">tatic</span>
  address 10.0.0.1
  netmask 255.255.255.0
EOF
vm1 $ ifup ens4
vm1 $ exit
vm1 $ exit</code></pre></div></li>
<li><p>vm2</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ssh</span> -p 5552 localhost
<span class="ex">vm2</span> $ sudo bash -c <span class="st">'echo 127.0.0.1 vm2 &gt;&gt; /etc/hosts'</span>
<span class="ex">vm2</span> $ sudo hostnamectl set-hostname vm2
<span class="ex">vm2</span> $ sudo su
<span class="ex">vm2</span> $ cat <span class="op">&lt;&lt; EOF</span> <span class="op">&gt;&gt;</span> <span class="ex">/etc/network/interfaces</span>
auto ens4
iface ens4 inet <span class="op">s</span><span class="ex">tatic</span>
  address 10.0.0.2
  netmask 255.255.255.0
EOF
vm2 $ ifup ens4
vm2 $ exit
vm2 $ exit</code></pre></div></li>
</ul>
<p>Make sure that your host firewall is not blocking the udp broadcast over port 1234</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="fu">sudo</span> iptables -A INPUT -p udp --dport 1234 -j ACCEPT</code></pre></div>
<h2 id="check-tcp-connectivity">Check tcp connectivity</h2>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm1</span> $ ping 10.0.0.2
<span class="ex">PING</span> 10.0.0.2 (10.0.0.2) <span class="ex">56</span>(84) <span class="ex">bytes</span> of data.
<span class="ex">64</span> bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.671 ms
<span class="ex">64</span> bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.776 ms</code></pre></div>
<h2 id="check-rdma-connectivity">Check RDMA connectivity</h2>
<ul>
<li><p>vm1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm1</span> $ sudo modprobe -a siw rdma_ucm
<span class="ex">vm1</span> $ rping -s -a 10.0.0.1 -v
<span class="ex">server</span> ping data: rdma-ping-0: ABCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="dt">\]</span>^_<span class="kw">`</span><span class="ex">abcdefghijklmnopqr</span>
<span class="ex">server</span> ping data: rdma-ping-1: BCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="dt">\]</span>^_<span class="kw">`</span>abcdefghijklmnopqrs
<span class="ex">server</span> DISCONNECT EVENT...
<span class="bu">wait</span> for RDMA_READ_ADV state 10</code></pre></div></li>
<li><p>vm2</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm2</span> $ sudo modprobe -a siw rdma_ucm
<span class="ex">vm2</span> $ rping -c -a 10.0.0.1 -C 2 -v
<span class="fu">ping</span> data: rdma-ping-0: ABCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="dt">\]</span>^_<span class="kw">`</span><span class="ex">abcdefghijklmnopqr</span>
<span class="fu">ping</span> data: rdma-ping-1: BCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="dt">\]</span>^_<span class="kw">`</span>abcdefghijklmnopqrs</code></pre></div></li>
</ul>
<h2 id="check-rdma-bandwidth-and-latency">Check RDMA bandwidth and latency</h2>
<h3 id="bandwidth">Bandwidth</h3>
<ul>
<li><p>vm1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm1</span> $ ibv_devices
<span class="ex">device</span>          	   node GUID
<span class="ex">------</span>          	----------------
<span class="ex">siw_ens3</span>        	5254001234560000
<span class="ex">siw_lo</span>          	7369775f6c6f0000
<span class="ex">siw_ens4</span>        	5254001234010000
<span class="ex">vm1</span> $ sudo su
<span class="ex">vm1</span> $ ulimit -l unlimited
<span class="ex">vm1</span> $ ib_write_bw -R -d siw_ens4 -i 1  -D 10 -F</code></pre></div></li>
<li><p>vm2</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm2</span> $ sudo su
<span class="ex">vm2</span> $ ulimit -l unlimited
<span class="ex">vm2</span> $ ib_write_bw -R -d siw_ens4 -i 1 -D 10 -F 10.0.0.1
<span class="ex">...</span>
 <span class="co">#bytes     #iterations    BW peak[MB/sec]    BW average[MB/sec]   MsgRate[Mpps]</span>
 <span class="ex">65536</span>      3200             0.00               33.33  		   0.000533</code></pre></div></li>
</ul>
<p>The results are really lame but please remember we are using virtual environment so performance is always bad here</p>
<h3 id="latency">Latency</h3>
<ul>
<li><p>vm1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm1</span> $ ib_write_lat -R -d siw_ens4 -i 1  -D 10 -F</code></pre></div></li>
<li><p>vm2</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">vm2</span> $ ib_write_lat -R -d siw_ens4 -i 1 -D 10 -F 10.0.0.1
<span class="ex">...</span>
 <span class="co">#bytes        #iterations       t_avg[usec]</span>
 <span class="ex">2</span>             4316            695.11</code></pre></div></li>
</ul>
<p>Same lame results due to the nature of our virtual setup and the use of softiwarp instead of real RDMA capable hardware</p>
<h1 id="summary">Summary</h1>
<p>Now we have a working setup of two vm’s which can communicate using RDMA. In the next posts we are going to explore more interesting RDMA stuff.</p>
</div>

            </div>
        </div>
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 left">
                        
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 center">
                        
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 right">
                        
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
